<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VGR Konst S√∂k</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="theme-color" content="#0077cc" />

  <style>
    :root{--brand:#0077cc;--brand-dark:#005a9e;--bg:#f7f9fc}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#222}
    header{padding:18px 16px;text-align:center}
    header h1{margin:0;color:#004a99;font-size:1.4rem}
    .wrap{max-width:1100px;margin:0 auto;padding:0 12px 28px}

    form#searchForm{
      display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));
      gap:10px 14px;background:#fff;padding:16px;border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.06)
    }
    .field{display:flex;flex-direction:column;gap:6px}
    .field input{
      padding:.65rem .75rem;border:1.5px solid #d0d7de;border-radius:8px;font-size:1rem;
      transition:border-color .2s, box-shadow .2s
    }
    .field input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 4px rgba(0,119,204,.12)}
    .actions{display:flex;gap:10px;align-items:end;justify-content:flex-start}
    button{
      border:none;border-radius:10px;padding:.7rem 1.1rem;font-weight:600;cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.08)
    }
    #searchBtn{background:var(--brand);color:#fff}
    #searchBtn:hover{background:var(--brand-dark)}
    #clearBtn{background:#e8eef5;color:#123}
    #clearBtn:hover{background:#dbe7f3}

    .table-wrap{margin-top:16px;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:auto}
    table{width:100%;border-collapse:collapse;min-width:800px}
    th,td{padding:12px 14px;border-bottom:1px solid #eee;text-align:left}
    th{background:var(--brand);color:#fff;cursor:pointer;user-select:none;position:sticky;top:0}
    tr:hover td{background:#f4f9ff}

    /* Mobil */
    @media (max-width: 820px){
      form#searchForm{grid-template-columns:1fr 1fr}
    }
    @media (max-width: 520px){
      header h1{font-size:1.15rem}
      form#searchForm{grid-template-columns:1fr}
      .actions{justify-content:stretch}
      #searchBtn,#clearBtn{width:100%}
      table{min-width:640px}
    }
  </style>
</head>
<body>
  <header><h1>VGR √∂ppna konstdata ‚Äì s√∂k</h1></header>
  <div class="wrap">

    <form id="searchForm" aria-label="S√∂k i datasetet">
      <label class="field">
        <span>Konstn√§r</span>
        <input type="search" id="creatorInput" placeholder="t.ex. Sara Gran√©r" autocomplete="off" />
      </label>
      <label class="field">
        <span>Titel</span>
        <input type="search" id="titleInput" placeholder="Titel" autocomplete="off" />
      </label>
      <label class="field">
        <span>Framst√§llnings√•r</span>
        <input type="search" id="createdInput" placeholder="√Ör" autocomplete="off" />
      </label>
      <label class="field">
        <span>Konsttyp</span>
        <input type="search" id="artformInput" placeholder="Konsttyp" autocomplete="off" />
      </label>
      <label class="field">
        <span>Teknik</span>
        <input type="search" id="artmediumInput" placeholder="Teknik" autocomplete="off" />
      </label>
      <label class="field">
        <span>VG-nummer</span>
        <input type="search" id="idInput" placeholder="VG-XXXX" autocomplete="off" />
      </label>
      <label class="field">
        <span>√Ñldre id</span>
        <input type="search" id="olderIdInput" placeholder="t.ex. 2345 R" autocomplete="off" />
      </label>

      <div class="actions">
        <button id="searchBtn" type="submit">S√∂k</button>
        <button id="clearBtn" type="button">Rensa</button>
      </div>
    </form>

    <div class="table-wrap" role="region" aria-label="Resultat">
      <table id="dataTable" role="grid" aria-live="polite" aria-relevant="all">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

  </div>

  <script>
    // ======= Konfiguration =======
    const datasetBaseURL = 'https://vgregion.entryscape.net/rowstore/dataset/1802e57a-b25d-4716-8437-9ed648bbae59';
    const BOM_OLDER_ID_KEY = '\uFEFFolder id';

    const columnsOrder = ["creator","title","created","artform","artmedium","id",BOM_OLDER_ID_KEY];
    const columnsMap = {
      "creator":"Konstn√§r","title":"Titel","created":"Framst√§llnings√•r",
      "artform":"Konsttyp","artmedium":"Teknik","id":"VG-nummer",[BOM_OLDER_ID_KEY]:"√Ñldre id"
    };
    const inputIdMap = {
      "creator":"creatorInput","title":"titleInput","created":"createdInput",
      "artform":"artformInput","artmedium":"artmediumInput","id":"idInput",[BOM_OLDER_ID_KEY]:"olderIdInput"
    };

    let allData = [];
    let currentSortColumn = null;
    let currentSortAsc = true;

    // ======= Hj√§lpfunktioner =======
    function removeAccents(str){ return str.normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase(); }
    function capitalizeWords(str){ return str.replace(/(^|\s)\S/g, c => c.toLocaleUpperCase('sv-SE')); }
    function normalizeText(str){ return str.normalize("NFC").trim(); }
    function normalizeOlderIdInput(input){
      input = normalizeText(input);
      if(!input) return '';
      if(/^\d+\s*[a-zA-Z]$/.test(input)){ return input.replace(/\s*([a-zA-Z])$/,(_,L)=>' '+L.toUpperCase()); }
      const m = input.match(/^(\d+)([a-zA-Z])$/);
      return m ? m[1] + ' ' + m[2].toUpperCase() : input;
    }
    function cleanDataKeys(dataArray){
      return dataArray.map(item=>{
        const n={}; for(const k in item){ n[k.replace(/^\uFEFF/,'')] = item[k]; } return n;
      });
    }
    function buildQuery(params){
      const parts=[];
      for(const key in params){
        if(params[key]){
          let actualKey = key, val = params[key];
          if(key==='older id'||key===BOM_OLDER_ID_KEY){ actualKey=BOM_OLDER_ID_KEY; val=normalizeOlderIdInput(val); }
          if(key==='id'){ val = val.toUpperCase(); }
          parts.push(encodeURIComponent(actualKey)+'='+encodeURIComponent(val));
        }
      }
      // H√§mta lite fler rader f√∂r lokalt filter/sort
      return parts.length ? '?'+parts.join('&')+'&_limit=500&_offset=0' : '?_limit=500&_offset=0';
    }

    // ======= H√§mtning + lokalt accent-insensitivt filter =======
    async function fetchData(params={}, rawSearch={}){
      const url = datasetBaseURL + buildQuery(params);
      console.log('üîç URL:', url);
      try{
        const res = await fetch(url, {headers:{accept:'application/json'}});
        if(!res.ok) throw new Error(`HTTP-fel: ${res.status}`);
        const json = await res.json();
        allData = cleanDataKeys(json.results || []);

        // Lokalt accent-insensitivt filter (alla ifyllda f√§lt)
        const filterKeys = Object.keys(rawSearch);
        if(filterKeys.length){
          allData = allData.filter(row=>{
            return filterKeys.every(key=>{
              const searchVal = removeAccents(String(rawSearch[key] ?? ''));
              const rowVal    = removeAccents(String(row[key] ?? ''));
              return rowVal.includes(searchVal);
            });
          });
        }
        renderTable(allData);
      }catch(err){
        alert('H√§mtfel: '+err.message);
      }
    }

    // ======= Tabell =======
    function renderTable(data){
      const thead = document.getElementById('tableHead');
      const tbody = document.getElementById('tableBody');
      thead.innerHTML=''; tbody.innerHTML='';

      // Header
      const trH=document.createElement('tr');
      columnsOrder.forEach(col=>{
        const th=document.createElement('th');
        th.textContent = columnsMap[col];
        th.onclick = ()=>sortTableByColumn(col);
        th.tabIndex=0;
        th.onkeypress=(e)=>{ if(e.key==='Enter'||e.key===' ') sortTableByColumn(col); };
        trH.appendChild(th);
      });
      thead.appendChild(trH);

      if(!data.length){
        const tr=document.createElement('tr');
        const td=document.createElement('td');
        td.colSpan=columnsOrder.length; td.textContent='Inga resultat.';
        tr.appendChild(td); tbody.appendChild(tr); return;
      }

      data.forEach(row=>{
        const tr=document.createElement('tr');
        columnsOrder.forEach(col=>{
          const key = col.replace(/^\uFEFF/,'');
          const td=document.createElement('td');
          let val=row[key] ?? '';
          if(key==='id' && typeof val==='string') val = val.toUpperCase();
          td.textContent = val;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function sortTableByColumn(col){
      const key = col.replace(/^\uFEFF/,'');
      const sorted = [...allData].sort((a,b)=>{
        const A = removeAccents(String(a[key] ?? ''));
        const B = removeAccents(String(b[key] ?? ''));
        if(A<B) return currentSortAsc ? -1 : 1;
        if(A>B) return currentSortAsc ?  1 : -1;
        return 0;
      });
      if(currentSortColumn===col){ currentSortAsc=!currentSortAsc; } else { currentSortAsc=true; currentSortColumn=col; }
      renderTable(sorted);
    }

    // ======= H√§ndelser =======
    document.getElementById('searchForm').addEventListener('submit', e=>{
      e.preventDefault();
      const params={}, raw={};
      for(const key in columnsMap){
        const cleanKey = key.replace(/^\uFEFF/,'');
        const input = document.getElementById(inputIdMap[key]);
        if(input){
          let val = normalizeText(input.value);
          if(val){
            if(cleanKey==='creator') val = capitalizeWords(val);
            if(cleanKey==='older id') val = normalizeOlderIdInput(val);
            params[cleanKey]=val; raw[cleanKey]=val;
          }
        }
      }
      fetchData(params, raw);
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      document.querySelectorAll('#searchForm input').forEach(i=>i.value='');
      allData=[]; renderTable(allData);
      // Vill du visa alla poster igen:
      fetchData({}, {});
    });

    // Startdata
    fetchData();

    // ======= PWA: registrera SW (relativ s√∂kv√§g f√∂r GitHub Pages) =======
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js')
        .then(r=>console.log('‚úÖ Service worker:', r.scope))
        .catch(err=>console.error('SW-fel:', err));
    }
  </script>
</body>
</html>
