<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VGR 칐ppna Data - S칬kbar Tabell</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 2rem auto; max-width: 1100px; background: #f7f9fc; color: #333; padding: 0 1rem; }
    h1 { text-align: center; margin-bottom: 2rem; color: #004a99; text-shadow: 0 0 5px rgba(0, 72, 153, 0.3); }
    form { display: flex; flex-wrap: wrap; gap: 1rem 2rem; margin-bottom: 2rem; justify-content: center; background: white; padding: 1.5rem 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.07); }
    label { display: flex; flex-direction: column; font-weight: 600; font-size: 1rem; color: #555; min-width: 180px; }
    input[type="search"] { padding: 0.5rem 0.75rem; font-size: 1rem; border: 1.5px solid #ccc; border-radius: 6px; margin-top: 0.3rem; width: 220px; box-sizing: border-box; transition: border-color 0.25s ease, box-shadow 0.25s ease; }
    input[type="search"]:focus { outline: none; border-color: #0078d4; box-shadow: 0 0 6px rgba(0, 120, 212, 0.6); }
    button { padding: 0.6rem 2rem; font-size: 1.1rem; background-color: #0078d4; color: white; border: none; border-radius: 8px; cursor: pointer; align-self: flex-end; height: 42px; font-weight: 600; transition: background-color 0.3s ease; box-shadow: 0 4px 8px rgba(0, 120, 212, 0.3); }
    button:hover { background-color: #005a9e; box-shadow: 0 6px 12px rgba(0, 90, 158, 0.5); }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 18px rgba(0,0,0,0.1); }
    th, td { padding: 1rem 1.25rem; border-bottom: 1px solid #eee; text-align: left; font-size: 1rem; color: #222; }
    th { background-color: #0078d4; color: white; cursor: pointer; user-select: none; transition: background-color 0.25s ease; }
    th:hover, th:focus { background-color: #005a9e; outline: none; }
    tr:hover { background-color: #e8f0fe; }
    @media (max-width: 700px) {
      form { flex-direction: column; align-items: stretch; }
      label { min-width: auto; width: 100%; }
      input[type="search"] { width: 100%; }
      button { width: 100%; }
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { display: none; }
      tr { margin-bottom: 1.2rem; border: 1px solid #ccc; border-radius: 10px; padding: 1rem; background: white; }
      td { padding: 0.6rem 0.8rem; border: none; position: relative; padding-left: 50%; text-align: right; font-size: 0.95rem; }
      td::before { position: absolute; top: 50%; left: 1rem; transform: translateY(-50%); white-space: nowrap; font-weight: 700; color: #555; content: attr(data-label); text-align: left; }
    }
  </style>
</head>
<body>

<h1>VGR 칬ppna konstdata</h1>

<form id="searchForm">
  <label><input type="search" id="creatorInput" placeholder="S칬k konstn칛r" autocomplete="off" /></label>
  <label><input type="search" id="titleInput" placeholder="S칬k titel" autocomplete="off" /></label>
  <label><input type="search" id="createdInput" placeholder="S칬k framst칛llnings친r" autocomplete="off" /></label>
  <label><input type="search" id="artformInput" placeholder="S칬k konsttyp" autocomplete="off" /></label>
  <label><input type="search" id="artmediumInput" placeholder="S칬k teknik" autocomplete="off" /></label>
  <label><input type="search" id="idInput" placeholder="S칬k VG-nummer" autocomplete="off" /></label>
  <label><input type="search" id="olderIdInput" placeholder="S칬k 칛ldre id" autocomplete="off" /></label>
  <button type="submit">S칬k</button>
</form>

<table id="dataTable">
  <thead id="tableHead"></thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
const datasetBaseURL = 'https://vgregion.entryscape.net/rowstore/dataset/1802e57a-b25d-4716-8437-9ed648bbae59';
const BOM_OLDER_ID_KEY = '\uFEFFolder id';

const columnsOrder = ["creator", "title", "created", "artform", "artmedium", "id", BOM_OLDER_ID_KEY];
const columnsMap = {
  "artform": "Konsttyp",
  "creator": "Konstn칛r",
  "created": "Framst칛llnings친r",
  "id": "VG-nummer",
  "title": "Titel",
  "artmedium": "Teknik",
  [BOM_OLDER_ID_KEY]: "츿ldre id"
};
const inputIdMap = {
  "artform": "artformInput",
  "creator": "creatorInput",
  "created": "createdInput",
  "id": "idInput",
  "title": "titleInput",
  "artmedium": "artmediumInput",
  [BOM_OLDER_ID_KEY]: "olderIdInput"
};

let allData = [];
let currentSortColumn = null;
let currentSortAsc = true;

// Tar bort accenter och g칬r till gemener
function removeAccents(str) {
  return str.normalize("NFD").replace(/\p{Diacritic}/gu, "").toLowerCase();
}

// Unicode- och lokalanpassad kapitalisering
function capitalizeWords(str) {
  return str.replace(/(^|\s)\S/g, c => c.toLocaleUpperCase('sv-SE'));
}

// Normalisera text (fixar accentformer och mellanslag)
function normalizeText(str) {
  return str.normalize("NFC").trim();
}

function normalizeOlderIdInput(input) {
  input = normalizeText(input);
  if (!input) return '';
  if (/^\d+\s*[a-zA-Z]$/.test(input)) {
    return input.replace(/\s*([a-zA-Z])$/, (_, letter) => ' ' + letter.toUpperCase());
  }
  const match = input.match(/^(\d+)([a-zA-Z])$/);
  if (match) {
    return match[1] + ' ' + match[2].toUpperCase();
  }
  return input;
}

function buildQuery(params) {
  const parts = [];
  for (const key in params) {
    if (params[key]) {
      let actualKey = key;
      let val = params[key];
      if (key === 'older id' || key === BOM_OLDER_ID_KEY) {
        actualKey = BOM_OLDER_ID_KEY;
        val = normalizeOlderIdInput(val);
      }
      if (key === 'id') {
        val = val.toUpperCase();
      }
      const encodedKey = encodeURIComponent(actualKey);
      const encodedVal = encodeURIComponent(val);
      parts.push(`${encodedKey}=${encodedVal}`);
    }
  }
  return parts.length ? '?' + parts.join('&') + '&_limit=500&_offset=0' : '?_limit=500&_offset=0';
}

async function fetchData(params = {}, rawSearchParams = {}) {
  const url = datasetBaseURL + buildQuery(params);
  console.log("游댌 Fr친gar p친 URL:", url);

  try {
    const res = await fetch(url, { headers: { accept: 'application/json' } });
    if (!res.ok) throw new Error(`HTTP-fel: ${res.status}`);
    let json = await res.json();
    allData = json.results || [];
    allData = cleanDataKeys(allData);

    // Lokalt accent-insensitivt filter
    allData = allData.filter(row => {
      return Object.keys(rawSearchParams).every(key => {
        const searchVal = removeAccents(rawSearchParams[key]);
        const rowVal = removeAccents(String(row[key] ?? ""));
        return rowVal.includes(searchVal);
      });
    });

    renderTable(allData);
  } catch (err) {
    alert('H칛mtfel: ' + err.message);
  }
}

function cleanDataKeys(dataArray) {
  return dataArray.map(item => {
    const newItem = {};
    for (const key in item) {
      const cleanKey = key.replace(/^\uFEFF/, '');
      newItem[cleanKey] = item[key];
    }
    return newItem;
  });
}

function renderTable(data) {
  const tableHead = document.getElementById('tableHead');
  const tableBody = document.getElementById('tableBody');
  tableHead.innerHTML = '';
  tableBody.innerHTML = '';

  if (data.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="100%">Inga resultat.</td></tr>';
    return;
  }

  const trHead = document.createElement('tr');
  columnsOrder.forEach(col => {
    const th = document.createElement('th');
    th.textContent = columnsMap[col];
    th.tabIndex = 0;
    th.onclick = () => sortTableByColumn(col);
    th.onkeypress = (e) => { if (e.key === 'Enter' || e.key === ' ') sortTableByColumn(col); };
    trHead.appendChild(th);
  });
  tableHead.appendChild(trHead);

  data.forEach(row => {
    const tr = document.createElement('tr');
    columnsOrder.forEach(col => {
      const cleanCol = col.replace(/^\uFEFF/, '');
      const td = document.createElement('td');
      let val = row[cleanCol] ?? '';
      if (cleanCol === 'id' && typeof val === 'string') val = val.toUpperCase();
      td.textContent = val;
      td.setAttribute('data-label', columnsMap[col]);
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);
  });
}

function sortTableByColumn(col) {
  const key = col.replace(/^\uFEFF/, '');
  const sorted = [...allData].sort((a, b) => {
    const valA = removeAccents(String(a[key] ?? ""));
    const valB = removeAccents(String(b[key] ?? ""));
    if (valA < valB) return currentSortAsc ? -1 : 1;
    if (valA > valB) return currentSortAsc ? 1 : -1;
    return 0;
  });
  if (currentSortColumn === col) {
    currentSortAsc = !currentSortAsc;
  } else {
    currentSortAsc = true;
    currentSortColumn = col;
  }
  renderTable(sorted);
}

document.getElementById('searchForm').addEventListener('submit', e => {
  e.preventDefault();

  const params = {};
  const rawParams = {};
  for (const key in columnsMap) {
    const cleanKey = key.replace(/^\uFEFF/, '');
    const input = document.getElementById(inputIdMap[key]);
    if (input) {
      let val = normalizeText(input.value);
      if (val) {
        if (cleanKey === 'creator') {
          val = capitalizeWords(val);
        }
        if (cleanKey === 'older id') {
          val = normalizeOlderIdInput(val);
        }
        params[cleanKey] = val;
        rawParams[cleanKey] = val;
      }
    }
  }

  fetchData(params, rawParams);
});

fetchData();
</script>

</body>
</html>
